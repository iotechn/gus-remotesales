<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dobbinsoft.gus.remotesales.mapper.OrderMapper">
    <resultMap id="ResultRefundOrderVo" type="com.dobbinsoft.gus.remotesales.data.vo.customer.OrderCustomerVo">
        <result column="customer_external_userid" property="customerExternalUserid" jdbcType= "VARCHAR"  />
        <result column="customer_gender" property="customerGender"  jdbcType= "INTEGER" />
        <result column="customer_nickname" property="customerNickname" jdbcType= "VARCHAR" />
        <result column="customer_avatar"  property="customerAvatar"  jdbcType= "VARCHAR" />
        <result column="created_date" property="lastOrderTime"  jdbcType="TIMESTAMP" />
        <result column="pay_amount" property="totalPrice" jdbcType="DECIMAL" />
        <result column="ca_name" property="lastSalesCaName" jdbcType="VARCHAR"/>

    </resultMap>

    <select id="selectOrderCustomer" resultMap="ResultRefundOrderVo">
        select ord.customer_external_userid,
        max(ord.customer_gender) as customer_gender,
        max(ord.customer_nickname) as customer_nickname,
        max(ord.customer_avatar) as customer_avatar,
        max(ord.created_date) as created_date,
        MAX(CASE WHEN ord.rn = 1 THEN ord.ca_name END) AS ca_name,
        sum(ord.pay_amount) as pay_amount
        from (SELECT *,
        ROW_NUMBER() OVER (
        PARTITION BY customer_unionid
        ORDER BY created_date DESC
        ) AS rn
        FROM rs_order
        <where>
            ${ew.sqlSegment}
        </where>
        ) ord
        GROUP BY  ord.customer_external_userid
    </select>

    <select id="selectOrderPerformance" resultType="com.dobbinsoft.gus.remotesales.data.vo.report.StorePerformanceVo">
        select
        SUM(amount) AS salesAmount,
        MAX(submit_time) AS lastSalesTime
        from
        rs_order
        WHERE
        store_id = #{storeId}
        <if test="regionId != null">
            AND region_id = #{regionId}
        </if>
        AND pay_status = 1
    </select>
    <select id="selectOrderAndItemByPage" resultType="com.dobbinsoft.gus.remotesales.data.vo.report.OrderItemExportVO">
        SELECT
        o.created_date,
        o.order_no AS orderNo,
        o.ca_wwid AS caWwid,
        o.ca_name AS caName,
        o.store_name AS storeName,
        o.customer_nickname AS customerNickname,
        o.status AS status,
        o.amount AS amount,
        o.pay_amount AS payAmount,
        o.delivery_method AS deliveryMethod,
        o.logistics_company AS logisticsCompany,
        o.logistics_no AS logisticsNo,
        o.pos_number AS posNumber,
        o.receipt_number AS receiptNumber,
        o.xstore_id AS xStoreId,
        i.sku AS sku,
        i.smc AS smc,
        i.product_name AS productName,
        i.product_desc AS productDesc,
        i.inner_remark AS innerRemark,
        i.remark AS remark,
        i.original_price AS originalPrice,
        i.price AS price,
        i.qty AS qty
        FROM
        (select * from rs_order
        <where>
            ${ew.sqlSegment}
        </where>
        ) o
        LEFT JOIN
        rs_order_item i ON o.id = i.order_id

        ORDER BY o.created_date,o.id DESC
    </select>
</mapper>